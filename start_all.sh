#!/bin/bash

# =============================================================================
# üöÄ TeleGuard Bot v3.1 - –°–¢–ê–†–¢–ï–† (—Å—Ç–∞—Ä—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤)
# =============================================================================

set -e # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "================================================================================="
echo "üöÄ TeleGuard Bot v3.1 - –ó–∞–ø—É—Å–∫ (6 –∞–≥–µ–Ω—Ç–æ–≤ + –ë–æ—Ç)"
echo "================================================================================="

export MISTRAL_API_KEY="ygeDdoQrYFW5iM8aVw2p18pPZ1se30ow"
export TMUX_PANE_TIMEOUT=0
export PYTHONUNBUFFERED=1

# =============================================================================
# üîç –ü–†–ï–î–°–¢–ê–†–¢–û–í–´–ï –ü–†–û–í–ï–†–ö–ò
# =============================================================================

echo "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

# 1. –£–ë–ò–í–ê–ï–ú –°–¢–ê–†–´–ï –ü–†–û–¶–ï–°–°–´
echo "üî™ –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -9 -f "python3.*agent" 2>/dev/null || true
pkill -9 -f "python3.*teleguard_bot" 2>/dev/null || true
pkill -9 -f "uvicorn" 2>/dev/null || true
sleep 2

# 2. –ü–†–û–í–ï–†–ö–ê REDIS
echo "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis..."
if ! redis-cli ping > /dev/null 2>&1; then
    echo "‚ùå Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
    exit 1
fi
redis-cli FLUSHDB
echo "‚úÖ Redis –æ—á–∏—â–µ–Ω"

# 3. –ü–†–û–í–ï–†–ö–ê MISTRAL API KEY
echo "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ Mistral API..."
if [ -z "$MISTRAL_API_KEY" ]; then
    echo "‚ùå MISTRAL_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo " export MISTRAL_API_KEY=\"your_key\""
    exit 1
fi

python3 -c "
import config
if config.MISTRAL_API_KEY == 'your_mistral_key_here':
    print('‚ùå Mistral API –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω')
    exit(1)
print('‚úÖ Mistral API: –ù–∞—Å—Ç—Ä–æ–µ–Ω')
" || exit 1

# 4. –ü–†–û–í–ï–†–ö–ê –í–°–ï–• –§–ê–ô–õ–û–í
echo "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤..."
for file in first_agent.py second_agent.py third_agent.py fourth_agent.py fifth_agent.py sixth_agent.py teleguard_bot.py; do
    if [ ! -f "$file" ]; then
        echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $file"
        exit 1
    fi
done
echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ"

# =============================================================================
# üöÄ –ó–ê–ü–£–°–ö –ê–ì–ï–ù–¢–û–í
# =============================================================================

echo ""
echo "================================================================================="
echo "ü§ñ –ó–∞–ø—É—Å–∫ 6 –∞–≥–µ–Ω—Ç–æ–≤ + –ë–æ—Ç..."
echo "================================================================================="

PIDS=()

# –ê–ì–ï–ù–¢ 1 - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
echo "‚ñ∂ –ó–∞–ø—É—Å–∫–∞—é: –ê–ì–ï–ù–¢ 1 (–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä)"
python3 first_agent.py > logs/agent1.log 2>&1 &
PIDS+=($!)
echo "‚úÖ –ê–ì–ï–ù–¢ 1 –∑–∞–ø—É—â–µ–Ω (PID: ${PIDS[-1]})"
sleep 3

# –ê–ì–ï–ù–¢ 2 - –ì–õ–ê–í–ù–´–ô MISTRAL ‚òÖ‚òÖ‚òÖ
echo "‚ñ∂ –ó–∞–ø—É—Å–∫–∞—é: –ê–ì–ï–ù–¢ 2 (–ì–ª–∞–≤–Ω—ã–π Mistral ‚òÖ)"
python3 second_agent.py > logs/agent2.log 2>&1 &
PIDS+=($!)
echo "‚úÖ –ê–ì–ï–ù–¢ 2 –∑–∞–ø—É—â–µ–Ω (PID: ${PIDS[-1]})"
sleep 5

# –ü–†–û–í–ï–†–ö–ê MISTRAL –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
echo "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Mistral (5 —Å–µ–∫)..."
sleep 5
if ! grep -q "‚úÖ Mistral AI –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω" logs/agent2.log 2>/dev/null; then
    echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: Mistral –ù–ï –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!"
    echo " –ü—Ä–æ–≤–µ—Ä—å—Ç–µ logs/agent2.log"
    echo " –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo " ‚Ä¢ –ù–µ–≤–µ—Ä–Ω—ã–π MISTRAL_API_KEY"
    echo " ‚Ä¢ –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞"
    echo " ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å mistralai –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π"
    exit 1
fi
echo "‚úÖ MISTRAL –ü–û–î–ö–õ–Æ–ß–ï–ù –£–°–ü–ï–®–ù–û!"

# –ê–ì–ï–ù–¢ 3 - –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π
echo "‚ñ∂ –ó–∞–ø—É—Å–∫–∞—é: –ê–ì–ï–ù–¢ 3 (–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)"
python3 third_agent.py > logs/agent3.log 2>&1 &
PIDS+=($!)
echo "‚úÖ –ê–ì–ï–ù–¢ 3 –∑–∞–ø—É—â–µ–Ω (PID: ${PIDS[-1]})"
sleep 2

# –ê–ì–ï–ù–¢ 4 - –°—Ç—Ä–æ–≥–∏–π
echo "‚ñ∂ –ó–∞–ø—É—Å–∫–∞—é: –ê–ì–ï–ù–¢ 4 (–°—Ç—Ä–æ–≥–∏–π)"
python3 fourth_agent.py > logs/agent4.log 2>&1 &
PIDS+=($!)
echo "‚úÖ –ê–ì–ï–ù–¢ 4 –∑–∞–ø—É—â–µ–Ω (PID: ${PIDS[-1]})"
sleep 2

# –ê–ì–ï–ù–¢ 5 - –ê—Ä–±–∏—Ç—Ä
echo "‚ñ∂ –ó–∞–ø—É—Å–∫–∞—é: –ê–ì–ï–ù–¢ 5 (–ê—Ä–±–∏—Ç—Ä)"
python3 fifth_agent.py > logs/agent5.log 2>&1 &
PIDS+=($!)
echo "‚úÖ –ê–ì–ï–ù–¢ 5 –∑–∞–ø—É—â–µ–Ω (PID: ${PIDS[-1]})"
sleep 2

# –ê–ì–ï–ù–¢ 6 - –ê–Ω–∞–ª–∏–∑ –º–µ–¥–∏–∞
echo "‚ñ∂ –ó–∞–ø—É—Å–∫–∞—é: –ê–ì–ï–ù–¢ 6 (–ê–Ω–∞–ª–∏–∑ –º–µ–¥–∏–∞)"
python3 sixth_agent.py > logs/agent6.log 2>&1 &
PIDS+=($!)
echo "‚úÖ –ê–ì–ï–ù–¢ 6 –∑–∞–ø—É—â–µ–Ω (PID: ${PIDS[-1]})"
sleep 2

# –ë–û–¢
echo "‚ñ∂ –ó–∞–ø—É—Å–∫–∞—é: ü§ñ TELEGRAM –ë–û–¢"
python3 teleguard_bot.py > logs/bot.log 2>&1 &
PIDS+=($!)
echo "‚úÖ ü§ñ –ë–û–¢ –∑–∞–ø—É—â–µ–Ω (PID: ${PIDS[-1]})"

echo ""
echo "================================================================================="
echo "‚úÖ ‚úÖ ‚úÖ –í–°–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –ó–ê–ü–£–©–ï–ù–´ –£–°–ü–ï–®–ù–û! ‚úÖ ‚úÖ ‚úÖ"
echo "================================================================================="
echo ""

# –ü–†–û–í–ï–†–ö–ê –ß–¢–û –í–°–ï –ó–ê–ü–£–©–ï–ù–û
echo "üìä –ü–†–û–í–ï–†–ö–ê –ü–†–û–¶–ï–°–°–û–í:"
sleep 2
if ps aux | grep -E "python3.*(agent|teleguard_bot)" | grep -v grep | wc -l | grep -q [789]; then
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–∫—Ç–∏–≤–Ω—ã"
else
    echo "‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
fi
ps aux | grep python3 | grep -E "(agent|teleguard_bot)" | grep -v grep | head -10

echo ""
echo "üìù –õ–û–ì–ò (—Ä–µ–∞–ª-—Ç–∞–π–º):"
echo "  tail -f logs/agent2.log  # ‚≠ê –ì–õ–ê–í–ù–´–ô (Mistral)"
echo "  tail -f logs/bot.log     # ü§ñ –ë–û–¢"
echo "  tail -f logs/agent6.log  # üì∏ –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ"
echo "  tail -f logs/agent*.log  # –í—Å–µ –∞–≥–µ–Ω—Ç—ã"
echo ""

echo "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:"
echo "  1. –û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç: '–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!' (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å OK)"
echo "  2. –û—Ç–ø—Ä–∞–≤—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ: '–¢—ã –¥—É—Ä–∞–∫!' (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–∞–Ω)"
echo "  3. –û—Ç–ø—Ä–∞–≤—å –§–û–¢–û - —Ç–µ–ø–µ—Ä—å –ë–ï–ó –∑–∞–≤–∏—Å–∞–Ω–∏—è ‚úÖ"
echo ""

echo "üõë –û–°–¢–ê–ù–û–í–ö–ê:"
echo "  ./stop_all.sh"
echo ""

echo "üìå PIDS (–¥–ª—è —Ä—É—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏): ${PIDS[*]}"
echo "================================================================================="

# –°–û–•–†–ê–ù–Ø–ï–ú PID'—ã
echo "${PIDS[*]}" > .tele_pids

# –ñ–¥–µ–º Ctrl+C
trap "echo ''; echo 'üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...'; ./stop_all.sh; exit" INT

wait


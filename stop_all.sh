#!/bin/bash

# ============================================================================
# üõë stop_all.sh ‚Äî –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤ –∏ –±–æ—Ç–∞
# ============================================================================

echo "================================================================================"
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ TeleGuard Bot v2.9"
echo "================================================================================"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞
log_info() {
    echo -e "\033[0;34m‚ñ∂ $1\033[0m"
}

log_success() {
    echo -e "\033[0;32m‚úÖ $1\033[0m"
}

log_warning() {
    echo -e "\033[1;33m‚ö†Ô∏è  $1\033[0m"
}

log_info "–ü–æ–∏—Å–∫ –≤—Å–µ—Ö Python –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ TeleGuard..."

# –°–ø–æ—Å–æ–± 1: –ø–æ —Ñ–∞–π–ª–∞–º PIDs (–µ—Å–ª–∏ –±—ã–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã —á–µ—Ä–µ–∑ start_all.sh)
if [ -f /tmp/teleguard_pids.txt ]; then
    log_info "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º PIDs..."
    while read pid; do
        if kill -0 "$pid" 2>/dev/null; then
            kill -TERM "$pid" 2>/dev/null
            log_success "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å PID: $pid"
        fi
    done < /tmp/teleguard_pids.txt
    rm -f /tmp/teleguard_pids.txt
fi

# –°–ø–æ—Å–æ–± 2: —É–±–∏–≤–∞–µ–º –≤—Å–µ Python –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≥–µ–Ω—Ç–æ–≤ (–ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
log_warning "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∞–≥–µ–Ω—Ç–æ–≤..."

pkill -f "python3.*first_agent.py" && log_success "–ê–≥–µ–Ω—Ç 1 –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sleep 1

pkill -f "python3.*second_agent.py" && log_success "–ê–≥–µ–Ω—Ç 2 –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sleep 1

pkill -f "python3.*third_agent.py" && log_success "–ê–≥–µ–Ω—Ç 3 –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sleep 1

pkill -f "python3.*fourth_agent.py" && log_success "–ê–≥–µ–Ω—Ç 4 –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sleep 1

pkill -f "python3.*fifth_agent.py" && log_success "–ê–≥–µ–Ω—Ç 5 –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sleep 1

pkill -f "python3.*sixth_agent.py" && log_success "–ê–≥–µ–Ω—Ç 6 –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sleep 1

pkill -f "python3.*teleguard_bot.py" && log_success "–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
sleep 1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å—ë –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å
REMAINING=$(pgrep -f "python3.*agent" | wc -l)

if [ "$REMAINING" -eq 0 ]; then
    log_success "–í–°–ï –ü–†–û–¶–ï–°–°–´ –û–°–¢–ê–ù–û–í–õ–ï–ù–´!"
else
    log_warning "–û—Å—Ç–∞–ª–∏—Å—å $REMAINING –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
    pkill -9 -f "python3.*agent"
    pkill -9 -f "python3.*bot"
    log_success "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
fi

echo ""
echo "================================================================================"
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:"
echo "   tail -f logs/*.log"
echo ""
echo "üöÄ –ù–æ–≤—ã–π –∑–∞–ø—É—Å–∫:"
echo "   ./start_all.sh"
echo "================================================================================"
